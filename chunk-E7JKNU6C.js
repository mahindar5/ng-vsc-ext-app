import{a as Oe,b as We}from"./chunk-ORM55WG6.js";import{c as Ge}from"./chunk-G25GONJB.js";import{a as U,b as Q}from"./chunk-XX53FIGM.js";import{a as z}from"./chunk-NGUIXSPP.js";import{a as Ie,b as ye,c as Be,e as Ee,f as Fe,g as Le,h as G,j as Ae}from"./chunk-3BEOCVQD.js";import{a as Je,b as Ke}from"./chunk-JHBRV5NF.js";import{a as $e,b as Ne,c as ze,d as qe,f as He,g as Ue,h as Qe}from"./chunk-SXYHQUWF.js";import{e as Pe}from"./chunk-3X4QDQRD.js";import{a as W,f as j}from"./chunk-X6DSTNHV.js";import{c as Ve,d as Re,e as J,g as K,h as Y}from"./chunk-34K7H2K6.js";import{b as je}from"./chunk-PAQ6KTT7.js";import{N as De,h as be}from"./chunk-376FPUNQ.js";import{$ as b,$a as o,$b as A,$c as Me,Ab as ve,Fa as P,Ga as se,Ka as ce,Kb as Ce,Pb as F,Ta as I,Ua as B,Va as E,Vb as xe,W as ie,Wa as me,X as ne,Xa as L,Ya as S,Z as re,Za as M,_a as h,a as v,ab as s,b as C,bb as y,da as d,ea as u,fa as X,fb as D,fc as we,ga as oe,gb as w,ib as _,jb as p,jd as $,l as te,ma as x,md as Te,nb as le,ob as pe,od as N,pb as de,pd as ke,qd as O,ra as ae,rb as ue,rd as q,sb as _e,sd as H,tb as V,ub as R,vb as ge,wa as m,wb as he,wc as Se,xb as c,yb as fe,zb as T}from"./chunk-2IW5L3VM.js";var it=["determinateSpinner"];function nt(a,g){if(a&1&&(X(),o(0,"svg",11),y(1,"circle",12),s()),a&2){let e=p();I("viewBox",e._viewBox()),m(),R("stroke-dasharray",e._strokeCircumference(),"px")("stroke-dashoffset",e._strokeCircumference()/2,"px")("stroke-width",e._circleStrokeWidth(),"%"),I("r",e._circleRadius())}}var rt=new re("mat-progress-spinner-default-options",{providedIn:"root",factory:ot});function ot(){return{diameter:Ze}}var Ze=100,at=10,Xe=(()=>{class a{_elementRef=b(ae);_noopAnimations;get color(){return this._color||this._defaultColor}set color(e){this._color=e}_color;_defaultColor="primary";_determinateCircle;constructor(){let e=b(rt),n=Me(),t=this._elementRef.nativeElement;this._noopAnimations=n==="di-disabled"&&!!e&&!e._forceAnimations,this.mode=t.nodeName.toLowerCase()==="mat-spinner"?"indeterminate":"determinate",!this._noopAnimations&&n==="reduced-motion"&&t.classList.add("mat-progress-spinner-reduced-motion"),e&&(e.color&&(this.color=this._defaultColor=e.color),e.diameter&&(this.diameter=e.diameter),e.strokeWidth&&(this.strokeWidth=e.strokeWidth))}mode;get value(){return this.mode==="determinate"?this._value:0}set value(e){this._value=Math.max(0,Math.min(100,e||0))}_value=0;get diameter(){return this._diameter}set diameter(e){this._diameter=e||0}_diameter=Ze;get strokeWidth(){return this._strokeWidth??this.diameter/10}set strokeWidth(e){this._strokeWidth=e||0}_strokeWidth;_circleRadius(){return(this.diameter-at)/2}_viewBox(){let e=this._circleRadius()*2+this.strokeWidth;return`0 0 ${e} ${e}`}_strokeCircumference(){return 2*Math.PI*this._circleRadius()}_strokeDashOffset(){return this.mode==="determinate"?this._strokeCircumference()*(100-this._value)/100:null}_circleStrokeWidth(){return this.strokeWidth/this.diameter*100}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=P({type:a,selectors:[["mat-progress-spinner"],["mat-spinner"]],viewQuery:function(n,t){if(n&1&&le(it,5),n&2){let i;pe(i=de())&&(t._determinateCircle=i.first)}},hostAttrs:["role","progressbar","tabindex","-1",1,"mat-mdc-progress-spinner","mdc-circular-progress"],hostVars:18,hostBindings:function(n,t){n&2&&(I("aria-valuemin",0)("aria-valuemax",100)("aria-valuenow",t.mode==="determinate"?t.value:null)("mode",t.mode),he("mat-"+t.color),R("width",t.diameter,"px")("height",t.diameter,"px")("--mat-progress-spinner-size",t.diameter+"px")("--mat-progress-spinner-active-indicator-width",t.diameter+"px"),ge("_mat-animation-noopable",t._noopAnimations)("mdc-circular-progress--indeterminate",t.mode==="indeterminate"))},inputs:{color:"color",mode:"mode",value:[2,"value","value",A],diameter:[2,"diameter","diameter",A],strokeWidth:[2,"strokeWidth","strokeWidth",A]},exportAs:["matProgressSpinner"],decls:14,vars:11,consts:[["circle",""],["determinateSpinner",""],["aria-hidden","true",1,"mdc-circular-progress__determinate-container"],["xmlns","http://www.w3.org/2000/svg","focusable","false",1,"mdc-circular-progress__determinate-circle-graphic"],["cx","50%","cy","50%",1,"mdc-circular-progress__determinate-circle"],["aria-hidden","true",1,"mdc-circular-progress__indeterminate-container"],[1,"mdc-circular-progress__spinner-layer"],[1,"mdc-circular-progress__circle-clipper","mdc-circular-progress__circle-left"],[3,"ngTemplateOutlet"],[1,"mdc-circular-progress__gap-patch"],[1,"mdc-circular-progress__circle-clipper","mdc-circular-progress__circle-right"],["xmlns","http://www.w3.org/2000/svg","focusable","false",1,"mdc-circular-progress__indeterminate-circle-graphic"],["cx","50%","cy","50%"]],template:function(n,t){if(n&1&&(ce(0,nt,2,8,"ng-template",null,0,Ce),o(2,"div",2,1),X(),o(4,"svg",3),y(5,"circle",4),s()(),oe(),o(6,"div",5)(7,"div",6)(8,"div",7),D(9,8),s(),o(10,"div",9),D(11,8),s(),o(12,"div",10),D(13,8),s()()()),n&2){let i=V(1);m(4),I("viewBox",t._viewBox()),m(),R("stroke-dasharray",t._strokeCircumference(),"px")("stroke-dashoffset",t._strokeDashOffset(),"px")("stroke-width",t._circleStrokeWidth(),"%"),I("r",t._circleRadius()),m(4),h("ngTemplateOutlet",i),m(2),h("ngTemplateOutlet",i),m(2),h("ngTemplateOutlet",i)}},dependencies:[we],styles:[`.mat-mdc-progress-spinner{--mat-progress-spinner-animation-multiplier: 1;display:block;overflow:hidden;line-height:0;position:relative;direction:ltr;transition:opacity 250ms cubic-bezier(0.4, 0, 0.6, 1)}.mat-mdc-progress-spinner circle{stroke-width:var(--mat-progress-spinner-active-indicator-width, 4px)}.mat-mdc-progress-spinner._mat-animation-noopable,.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__determinate-circle{transition:none !important}.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__indeterminate-circle-graphic,.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__spinner-layer,.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__indeterminate-container{animation:none !important}.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__indeterminate-container circle{stroke-dasharray:0 !important}@media(forced-colors: active){.mat-mdc-progress-spinner .mdc-circular-progress__indeterminate-circle-graphic,.mat-mdc-progress-spinner .mdc-circular-progress__determinate-circle{stroke:currentColor;stroke:CanvasText}}.mat-progress-spinner-reduced-motion{--mat-progress-spinner-animation-multiplier: 1.25}.mdc-circular-progress__determinate-container,.mdc-circular-progress__indeterminate-circle-graphic,.mdc-circular-progress__indeterminate-container,.mdc-circular-progress__spinner-layer{position:absolute;width:100%;height:100%}.mdc-circular-progress__determinate-container{transform:rotate(-90deg)}.mdc-circular-progress--indeterminate .mdc-circular-progress__determinate-container{opacity:0}.mdc-circular-progress__indeterminate-container{font-size:0;letter-spacing:0;white-space:nowrap;opacity:0}.mdc-circular-progress--indeterminate .mdc-circular-progress__indeterminate-container{opacity:1;animation:mdc-circular-progress-container-rotate calc(1568.2352941176ms*var(--mat-progress-spinner-animation-multiplier)) linear infinite}.mdc-circular-progress__determinate-circle-graphic,.mdc-circular-progress__indeterminate-circle-graphic{fill:rgba(0,0,0,0)}.mat-mdc-progress-spinner .mdc-circular-progress__determinate-circle,.mat-mdc-progress-spinner .mdc-circular-progress__indeterminate-circle-graphic{stroke:var(--mat-progress-spinner-active-indicator-color, var(--mat-sys-primary))}@media(forced-colors: active){.mat-mdc-progress-spinner .mdc-circular-progress__determinate-circle,.mat-mdc-progress-spinner .mdc-circular-progress__indeterminate-circle-graphic{stroke:CanvasText}}.mdc-circular-progress__determinate-circle{transition:stroke-dashoffset 500ms cubic-bezier(0, 0, 0.2, 1)}.mdc-circular-progress__gap-patch{position:absolute;top:0;left:47.5%;box-sizing:border-box;width:5%;height:100%;overflow:hidden}.mdc-circular-progress__gap-patch .mdc-circular-progress__indeterminate-circle-graphic{left:-900%;width:2000%;transform:rotate(180deg)}.mdc-circular-progress__circle-clipper .mdc-circular-progress__indeterminate-circle-graphic{width:200%}.mdc-circular-progress__circle-right .mdc-circular-progress__indeterminate-circle-graphic{left:-100%}.mdc-circular-progress--indeterminate .mdc-circular-progress__circle-left .mdc-circular-progress__indeterminate-circle-graphic{animation:mdc-circular-progress-left-spin calc(1333ms*var(--mat-progress-spinner-animation-multiplier)) cubic-bezier(0.4, 0, 0.2, 1) infinite both}.mdc-circular-progress--indeterminate .mdc-circular-progress__circle-right .mdc-circular-progress__indeterminate-circle-graphic{animation:mdc-circular-progress-right-spin calc(1333ms*var(--mat-progress-spinner-animation-multiplier)) cubic-bezier(0.4, 0, 0.2, 1) infinite both}.mdc-circular-progress__circle-clipper{display:inline-flex;position:relative;width:50%;height:100%;overflow:hidden}.mdc-circular-progress--indeterminate .mdc-circular-progress__spinner-layer{animation:mdc-circular-progress-spinner-layer-rotate calc(5332ms*var(--mat-progress-spinner-animation-multiplier)) cubic-bezier(0.4, 0, 0.2, 1) infinite both}@keyframes mdc-circular-progress-container-rotate{to{transform:rotate(360deg)}}@keyframes mdc-circular-progress-spinner-layer-rotate{12.5%{transform:rotate(135deg)}25%{transform:rotate(270deg)}37.5%{transform:rotate(405deg)}50%{transform:rotate(540deg)}62.5%{transform:rotate(675deg)}75%{transform:rotate(810deg)}87.5%{transform:rotate(945deg)}100%{transform:rotate(1080deg)}}@keyframes mdc-circular-progress-left-spin{from{transform:rotate(265deg)}50%{transform:rotate(130deg)}to{transform:rotate(265deg)}}@keyframes mdc-circular-progress-right-spin{from{transform:rotate(-265deg)}50%{transform:rotate(-130deg)}to{transform:rotate(-265deg)}}
`],encapsulation:2,changeDetection:0})}return a})();var et=(()=>{class a{static \u0275fac=function(n){return new(n||a)};static \u0275mod=se({type:a});static \u0275inj=ne({imports:[Te]})}return a})();var ut=["itemList"];function _t(a,g){if(a&1){let e=w();o(0,"mat-list-option",13),_("selectedChange",function(t){let i=d(e).$implicit,r=p();return u(r.toggleSelection(i,t))}),c(1),s()}if(a&2){let e=g.$implicit,n=p();h("value",e)("selected",n.isSelected(e))("matTooltip",e),m(),T(" ",e," ")}}var tt=(()=>{class a{dialogRef=b(Ie);dataSignal=x(b(ye));searchTerm=x("");selectedItems=x([...this.dataSignal().selected]);filtered=F(()=>{let e=this.searchTerm().toLowerCase();return this.dataSignal().items.filter(n=>n.toLowerCase().includes(e))});canAdd=F(()=>{let e=this.searchTerm().trim();return e!==""&&!this.dataSignal().items.includes(e)});itemList=xe.required("itemList");addItem(){let e=this.searchTerm().trim();if(!e||this.dataSignal().items.includes(e))return;let n=C(v({},this.dataSignal()),{items:[...this.dataSignal().items,e]});this.dataSignal.set(n),this.searchTerm.set("")}apply(){this.dialogRef.close(this.selectedItems())}toggleSelection(e,n){let t=this.selectedItems();n&&!t.includes(e)?this.selectedItems.set([...t,e]):!n&&t.includes(e)&&this.selectedItems.set(t.filter(i=>i!==e))}isSelected(e){return this.selectedItems().includes(e)}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=P({type:a,selectors:[["lib-list-item-selector-dialog"]],viewQuery:function(n,t){n&1&&ue(t.itemList,ut,5),n&2&&_e()},decls:22,vars:4,consts:[["itemList","matSelectionList"],["mat-dialog-title",""],[2,"height","calc(100vh - 60px)","display","flex","flex-direction","column"],[1,"search-add-container",2,"display","flex","align-items","center","gap","8px"],["appearance","fill",1,"search-field",2,"flex","1"],["matInput","","placeholder","Type to filter...","aria-label","Search Items",3,"input","value"],["mat-icon-button","","color","primary","aria-label","Add new item",3,"click","disabled"],[1,"selection-count",2,"font-size","12px","text-align","right","margin-bottom","8px"],[2,"flex","1","overflow","auto"],["matTooltipShowDelay","500",3,"value","selected","matTooltip"],["align","end"],["mat-button","",3,"click"],["mat-button","","color","primary",3,"click"],["matTooltipShowDelay","500",3,"selectedChange","value","selected","matTooltip"]],template:function(n,t){if(n&1){let i=w();o(0,"h2",1),c(1,"Select Items"),s(),o(2,"mat-dialog-content",2)(3,"div",3)(4,"mat-form-field",4)(5,"mat-label"),c(6,"Search items"),s(),o(7,"input",5),_("input",function(l){return d(i),u(t.searchTerm.set(l.target.value))}),s()(),o(8,"button",6),_("click",function(){return d(i),u(t.addItem())}),o(9,"mat-icon"),c(10,"add"),s()()(),o(11,"div",7),c(12),s(),o(13,"mat-selection-list",8,0),S(15,_t,2,4,"mat-list-option",9,L),s()(),o(17,"mat-dialog-actions",10)(18,"button",11),_("click",function(){return d(i),u(t.dialogRef.close())}),c(19,"Cancel"),s(),o(20,"button",12),_("click",function(){return d(i),u(t.apply())}),c(21,"Add"),s()()}n&2&&(m(7),h("value",t.searchTerm()),m(),h("disabled",!t.canAdd()),m(4),ve(" ",t.selectedItems().length," / ",t.dataSignal().items.length," items "),m(3),M(t.filtered()))},dependencies:[Ke,Je,G,Ee,Le,Fe,z,j,W,Q,U,Y,K,J,O,N,$,H,q],encapsulation:2,changeDetection:0})}return a})();var Z=(a,g)=>g.value;function gt(a,g){if(a&1){let e=w();o(0,"mat-list-option",10),_("click",function(t){let i=d(e),r=i.$implicit,l=i.$index,f=p(2);return t.preventDefault(),u(f.toggleCommonTarget(l,r.value,!r.selected))}),o(1,"button",11),_("click",function(t){let i=d(e).$implicit,r=p(2);return t.stopPropagation(),u(r.removeCommonTarget(i.value))}),o(2,"mat-icon"),c(3,"close"),s()(),c(4),s()}if(a&2){let e=g.$implicit;h("value",e.value)("selected",e.selected),m(4),T(" ",e.value," ")}}function ht(a,g){if(a&1&&(o(0,"div")(1,"mat-label"),c(2,"Common Targets"),s(),o(3,"mat-selection-list",null,1),S(5,gt,5,3,"mat-list-option",9,Z),s()()),a&2){let e=p();m(5),M(e.commonTargets())}}function ft(a,g){if(a&1){let e=w();o(0,"mat-list-option",10),_("click",function(t){let i=d(e),r=i.$implicit,l=i.$index,f=p(2);return t.preventDefault(),u(f.toggleCommonPrompt(l,r.value,!r.selected))}),o(1,"button",11),_("click",function(t){let i=d(e).$implicit,r=p(2);return t.stopPropagation(),u(r.removeCommonPrompt(i.value))}),o(2,"mat-icon"),c(3,"close"),s()(),c(4),s()}if(a&2){let e=g.$implicit;h("value",e.value)("selected",e.selected),m(4),T(" ",e.value," ")}}function vt(a,g){if(a&1&&(o(0,"div")(1,"mat-label"),c(2,"Common Prompts"),s(),o(3,"mat-selection-list",null,2),S(5,ft,5,3,"mat-list-option",9,Z),s()()),a&2){let e=p();m(5),M(e.commonPrompts())}}function Ct(a,g){if(a&1){let e=w();o(0,"mat-list-option",10),_("click",function(t){let i=d(e).$implicit,r=p().$index,l=p(2);return t.preventDefault(),u(l.toggleTarget(r,i.value,!i.selected))}),o(1,"button",11),_("click",function(t){let i=d(e).$implicit,r=p().$index,l=p(2);return t.stopPropagation(),u(l.removeTarget(r,i.value))}),o(2,"mat-icon"),c(3,"close"),s()(),c(4),s()}if(a&2){let e=g.$implicit;h("value",e.value)("selected",e.selected),m(4),T(" ",e.value," ")}}function xt(a,g){if(a&1){let e=w();o(0,"mat-list-option",10),_("click",function(t){let i=d(e).$implicit,r=p().$index,l=p(2);return t.preventDefault(),u(l.togglePrompt(r,i.value,!i.selected))}),o(1,"button",18),_("click",function(t){let i=d(e).$implicit,r=p().$index,l=p(2);return t.stopPropagation(),u(l.runItemPrompt(r,i.value))}),o(2,"mat-icon"),c(3,"play_arrow"),s()(),o(4,"button",11),_("click",function(t){let i=d(e).$implicit,r=p().$index,l=p(2);return t.stopPropagation(),u(l.removePrompt(r,i.value))}),o(5,"mat-icon"),c(6,"close"),s()(),c(7),s()}if(a&2){let e=g.$implicit,n=p(3);h("value",e.value)("selected",e.selected),m(),h("disabled",n.isProcessing()),m(6),T(" ",e.value," ")}}function wt(a,g){if(a&1){let e=w();o(0,"mat-expansion-panel")(1,"mat-expansion-panel-header")(2,"mat-panel-title"),c(3),s(),o(4,"div",16),_("click",function(t){return d(e),u(t.stopPropagation())}),o(5,"button",17),_("click",function(){let t=d(e).$index,i=p(2);return u(i.addTargets(t))}),o(6,"mat-icon"),c(7,"add"),s()(),o(8,"button",17),_("click",function(){let t=d(e).$index,i=p(2);return u(i.addPromptsToBatch(t))}),o(9,"mat-icon"),c(10,"format_list_bulleted"),s()(),o(11,"button",11),_("click",function(){let t=d(e).$index,i=p(2);return u(i.removeBatchItem(t))}),o(12,"mat-icon"),c(13,"delete"),s()()()(),o(14,"div")(15,"h3"),c(16,"Targets"),s(),o(17,"mat-selection-list"),S(18,Ct,5,3,"mat-list-option",9,Z),s()(),o(20,"div")(21,"h3"),c(22,"Prompts"),s(),o(23,"mat-selection-list"),S(24,xt,8,4,"mat-list-option",9,Z),s()()()}if(a&2){let e=g.$implicit,n=g.$index;m(3),T("Batch ",n+1),m(15),M(e.targets),m(6),M(e.prompts)}}function bt(a,g){a&1&&y(0,"mat-progress-spinner",15)}function St(a,g){if(a&1&&(o(0,"mat-list-item"),c(1),s()),a&2){let e=g.$implicit;m(),fe(e)}}function Mt(a,g){if(a&1){let e=w();o(0,"mat-accordion"),S(1,wt,26,1,"mat-expansion-panel",null,me),s(),o(3,"div")(4,"mat-form-field",12)(5,"mat-label"),c(6,"Delay (minutes)"),s(),o(7,"input",13),_("input",function(t){d(e);let i=p();return u(i.delayInMinutes.set(+t.target.value))}),s()(),o(8,"button",14),_("click",function(){d(e);let t=p();return u(t.runAllPrompts())}),c(9," Master Submit All "),s()(),B(10,bt,1,0,"mat-progress-spinner",15),o(11,"mat-list"),S(12,St,2,1,"mat-list-item",null,L),s()}if(a&2){let e=p();m(),M(e.batchItems()),m(6),h("value",e.delayInMinutes()),m(),h("disabled",!e.hasBatchItems()),m(2),E(e.isProcessing()?10:-1),m(2),M(e.sessionLogs())}}var Tt=(()=>{class a{exportConfig(e){let n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),t=URL.createObjectURL(n),i=document.createElement("a");i.href=t,i.download="batch-config.json",i.click(),URL.revokeObjectURL(t)}importConfig(e){return new Promise((n,t)=>{let i=new FileReader;i.onload=()=>{try{let r=JSON.parse(i.result);n(r)}catch(r){t(r)}},i.onerror=r=>t(r),i.readAsText(e)})}static \u0275fac=function(n){return new(n||a)};static \u0275prov=ie({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),wi=(()=>{class a{dialog=b(Be);configService=b(Tt);snackBar=b(Oe);batchItems=x([]);commonPrompts=x([]);commonTargets=x([]);isProcessing=x(!1);sessionLogs=x([]);delayInMinutes=x(5);isClientActive=x(!1);hasBatchItems=F(()=>this.batchItems().length>0);initialDelayMs=1e3;pingTimeoutMs=5e3;offlineFileList=[];ngOnInit(){this.pingClient()}async addBatchItem(){let e=await this.getWorkspaceFiles();this.openFileSelector(e,[],n=>{this.batchItems.update(t=>[...t,...n.map(i=>({targets:[{value:i,selected:!0}],prompts:[]}))])})}removeBatchItem(e){this.updateBatchItemsExcluding(e)}async addTargets(e){let n=this.batchItems()[e],t=await this.getWorkspaceFiles(),i=n.targets.map(r=>r.value);this.openFileSelector(t,i,r=>{this.updateBatchItemAtIndex(e,C(v({},this.batchItems()[e]),{targets:r.map(l=>({value:l,selected:!0}))}))})}removeTarget(e,n){let t=this.batchItems()[e];this.updateBatchItemAtIndex(e,C(v({},t),{targets:t.targets.filter(i=>i.value!==n)}))}toggleTarget(e,n,t){let i=this.batchItems()[e];this.updateBatchItemAtIndex(e,C(v({},i),{targets:i.targets.map(r=>r.value===n?C(v({},r),{selected:t}):r)}))}addPromptsToBatch(e){let n=this.batchItems()[e],t=n.prompts.map(r=>r.value),i=n.prompts.filter(r=>r.selected).map(r=>r.value);this.openItemSelector(t,i,r=>{let l=r.map(f=>n.prompts.find(k=>k.value===f)||{value:f,selected:!0});this.updateBatchItemAtIndex(e,C(v({},n),{prompts:l}))})}removePrompt(e,n){let t=this.batchItems()[e];this.updateBatchItemAtIndex(e,C(v({},t),{prompts:t.prompts.filter(i=>i.value!==n)}))}togglePrompt(e,n,t){let i=this.batchItems()[e];this.updateBatchItemAtIndex(e,C(v({},i),{prompts:i.prompts.map(r=>r.value===n?C(v({},r),{selected:t}):r)}))}selectCommonPrompts(){let e=this.commonPrompts().map(t=>t.value),n=this.commonPrompts().filter(t=>t.selected).map(t=>t.value);this.openItemSelector(e,n,t=>{let i=t.map(r=>this.commonPrompts().find(f=>f.value===r)||{value:r,selected:!0});this.commonPrompts.set(this.createDeepCopy(i))})}removeCommonPrompt(e){this.commonPrompts.set(this.commonPrompts().filter(n=>n.value!==e))}toggleCommonPrompt(e,n,t){this.commonPrompts.set(this.commonPrompts().map((i,r)=>r===e?C(v({},i),{selected:t}):i))}async selectCommonTargets(){let e=await this.getWorkspaceFiles(),n=this.commonTargets().filter(t=>t.selected).map(t=>t.value);this.openFileSelector(e,n,t=>{let i=t.map(r=>this.commonTargets().find(f=>f.value===r)||{value:r,selected:!0});this.commonTargets.set(i)})}removeCommonTarget(e){this.commonTargets.set(this.commonTargets().filter(n=>n.value!==e))}toggleCommonTarget(e,n,t){this.commonTargets.set(this.commonTargets().map((i,r)=>r===e?C(v({},i),{selected:t}):i))}async runItemPrompt(e,n){let i=this.batchItems()[e].targets.filter(r=>r.selected).map(r=>r.value);this.isProcessing.set(!0),await this.executePromptSession(i,n),this.isProcessing.set(!1)}async runAllPrompts(){this.isProcessing.set(!0);for(let e of this.batchItems()){let n=[...e.prompts.filter(i=>i.selected).map(i=>i.value),...this.commonPrompts().filter(i=>i.selected).map(i=>i.value)],t=[...e.targets.filter(i=>i.selected).map(i=>i.value),...this.commonTargets().filter(i=>i.selected).map(i=>i.value)];for(let i of n)await this.executePromptSession(t,i),await this.delay(this.delayInMinutes()*60*1e3)}this.isProcessing.set(!1),this.sessionLogs.update(e=>[...e,"Master submission completed"])}saveConfig(){let e={batchItems:this.batchItems(),commonPrompts:this.commonPrompts(),commonTargets:this.commonTargets(),offlineFileList:this.offlineFileList};this.configService.exportConfig(e)}uploadConfig(e){let n=e.target,t=n.files?.[0];t&&(this.configService.importConfig(t).then(i=>{this.batchItems.set(i.batchItems),this.commonPrompts.set(i.commonPrompts),this.commonTargets.set(i.commonTargets),i.offlineFileList?.length&&(this.offlineFileList=i.offlineFileList)}),n.value="")}async getWorkspaceFiles(){return this.isClientActive()?new Promise(e=>{let n=i=>{if(i.data?.command==="workspaceFiles"){window.removeEventListener("message",n);let r=i.data.files??[];clearTimeout(t),r.length>0?(this.offlineFileList=r,e(r)):this.offlineFileList.length>0?(this.snackBar.open("Loading files from cached list","Close",{duration:3e3}),e(this.offlineFileList)):e([])}};window.addEventListener("message",n),window.parent.postMessage({command:"getWorkspaceFiles"},"*");let t=setTimeout(()=>{window.removeEventListener("message",n),this.offlineFileList.length>0?(this.snackBar.open("Timed out loading workspace files, using cached list","Close",{duration:4e3}),e(this.offlineFileList)):e([])},15e3)}):this.offlineFileList.length>0?(this.snackBar.open("Using cached file list (client not active)","Close",{duration:4e3}),this.offlineFileList):(this.snackBar.open("Client not active and no cached files available","Close",{duration:4e3}),[])}openFileSelector(e,n,t){this.openItemSelector(e,n,t)}openItemSelector(e,n,t){this.dialog.open(tt,{data:{items:e.sort(),selected:n},height:"calc(100% - 30px)",width:"calc(100% - 30px)",maxWidth:"100%",maxHeight:"100%"}).afterClosed().subscribe(r=>{r&&t(r)})}updateBatchItemsExcluding(e){let n=this.createDeepCopy(this.batchItems());this.batchItems.set(n.filter((t,i)=>i!==e))}updateBatchItemAtIndex(e,n){let i=this.createDeepCopy(this.batchItems()).map((r,l)=>l===e?n:r);this.batchItems.set(i)}async executePromptSession(e,n){let t=this.sendCommandAsync("getContextKeyValue","chatEdits.isRequestInProgress");await this.sendCommandAsync("workbench.action.chat.newEditSession");for(let i of e)await this.sendCommandAsync("workbench.action.chat.attachFile",i);await this.sendCommandAsync("workbench.action.chat.open",{mode:"agent",query:n})}sendCommand(e,n){window.parent.postMessage({command:"executeCommand",commandName:e,args:n},"*")}async sendCommandAsync(e,n,t=5e3){return new Promise((i,r)=>{let l=Date.now().toString()+Math.random().toString(36),f=k=>{k.data?.command==="commandResponse"&&k.data?.requestId===l&&(window.removeEventListener("message",f),clearTimeout(ee),k.data.success?i(k.data.result):r(new Error(k.data.error||`Command '${e}' failed`)))};window.addEventListener("message",f),window.parent.postMessage({command:"executeCommand",commandName:e,args:n,requestId:l},"*");let ee=setTimeout(()=>{window.removeEventListener("message",f),r(new Error(`Command '${e}' timed out after ${t}ms`))},t)})}delay(e){return new Promise(n=>setTimeout(n,e))}pingClient(){return new Promise(e=>{let n=i=>{i.data?.command==="ping"&&i.data?.message==="pong"&&(window.removeEventListener("message",n),clearTimeout(t),this.isClientActive.set(!0),this.sessionLogs.update(r=>[...r,"Client connection active"]),e(!0))};window.addEventListener("message",n),window.parent.postMessage({command:"ping"},"*");let t=setTimeout(()=>{window.removeEventListener("message",n),this.isClientActive.set(!1),this.sessionLogs.update(i=>[...i,"Client connection not detected"]),this.snackBar.open("Client connection not detected, using offline mode","Close",{duration:4e3}),e(!1)},this.pingTimeoutMs)})}createDeepCopy(e){return JSON.parse(JSON.stringify(e))}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=P({type:a,selectors:[["lib-prompt-batch-runner"]],decls:25,vars:3,consts:[["configInput",""],["commonTargetsList",""],["commonPromptsList",""],["mat-mini-fab","","color","primary",3,"click"],["mat-mini-fab","","color","accent","aria-label","Select Common Prompts",3,"click"],["mat-mini-fab","","color","accent","aria-label","Select Common Targets",3,"click"],["type","file","accept","application/json","hidden","",3,"change"],["mat-mini-fab","","color","primary","aria-label","Upload Config",3,"click"],["mat-mini-fab","","color","primary","aria-label","Save Config",3,"click"],[3,"value","selected"],[3,"click","value","selected"],["mat-icon-button","","color","warn",3,"click"],["appearance","fill"],["matInput","","type","number","min","1","required","",3,"input","value"],["mat-raised-button","","color","primary",3,"click","disabled"],["diameter","50","mode","indeterminate"],[3,"click"],["mat-icon-button","",3,"click"],["mat-icon-button","","color","primary",3,"click","disabled"]],template:function(n,t){if(n&1){let i=w();o(0,"mat-toolbar")(1,"span"),c(2,"Prompt Batch Runner"),s()(),y(3,"span"),o(4,"div")(5,"button",3),_("click",function(){return d(i),u(t.addBatchItem())}),o(6,"mat-icon"),c(7,"add"),s()(),o(8,"button",4),_("click",function(){return d(i),u(t.selectCommonPrompts())}),o(9,"mat-icon"),c(10,"format_list_bulleted"),s()(),o(11,"button",5),_("click",function(){return d(i),u(t.selectCommonTargets())}),o(12,"mat-icon"),c(13,"folder"),s()(),o(14,"input",6,0),_("change",function(l){return d(i),u(t.uploadConfig(l))}),s(),o(16,"button",7),_("click",function(){d(i);let l=V(15);return u(l.click())}),o(17,"mat-icon"),c(18,"upload"),s()(),o(19,"button",8),_("click",function(){return d(i),u(t.saveConfig())}),o(20,"mat-icon"),c(21,"save"),s()()(),B(22,ht,7,0,"div"),B(23,vt,7,0,"div"),B(24,Mt,14,3)}n&2&&(m(22),E(t.commonTargets().length?22:-1),m(),E(t.commonPrompts().length?23:-1),m(),E(t.hasBatchItems()?24:-1))},dependencies:[Se,Pe,O,N,ke,$,H,q,z,j,W,Q,U,Y,Ve,K,Re,J,De,Ae,et,Xe,Qe,Ue,ze,qe,He,Ne,$e,We,je,G,Ge],encapsulation:2,changeDetection:0})}return te([be({message:"Loading workspace files..."})],a.prototype,"getWorkspaceFiles",null),a})();export{wi as PromptBatchRunnerComponent};
