import{a as We,b as je}from"./chunk-TOA6QLKR.js";import{c as Ge}from"./chunk-YZHBBPAW.js";import{a as U,b as Q}from"./chunk-5PWFBBMJ.js";import{a as z}from"./chunk-Q3H3C2UG.js";import{a as ye,b as Me,c as Be,e as Ee,f as Fe,g as Le,h as G,j as Ae}from"./chunk-GXEOD7DE.js";import{a as Je,b as Ke}from"./chunk-YDM6HEY4.js";import{a as $e,b as Oe,c as ze,d as qe,f as He,g as Ue,h as Qe}from"./chunk-4MYMD637.js";import{e as Ie}from"./chunk-U5K5244M.js";import{a as j,f as N}from"./chunk-ZBVV545M.js";import{c as Re,d as De,e as J,g as K,h as Y}from"./chunk-AJ2BURRL.js";import{b as Ne}from"./chunk-7WZJHJDG.js";import{N as Ve,h as Se}from"./chunk-KTMJKSKR.js";import{$ as S,$a as o,Fa as I,Ga as se,Hb as ve,Ka as ce,Mb as F,Sb as xe,Ta as y,Ua as B,Va as E,W as ie,Wa as me,X as re,Xa as L,Ya as b,Yb as A,Yc as Te,Z as ne,Za as T,_a as h,a as C,ab as s,b as v,bb as M,cb as V,cc as we,da as d,db as w,ea as u,fa as X,fb as _,fd as $,ga as oe,gb as p,id as ke,kb as le,kd as O,l as te,lb as pe,ld as Pe,ma as x,mb as de,md as W,nd as q,ob as ue,od as H,pb as _e,qb as R,ra as ae,rb as D,sb as ge,tb as he,tc as be,ub as c,vb as fe,wa as m,wb as k,xb as Ce}from"./chunk-LIMSH4HP.js";var it=["determinateSpinner"];function rt(a,g){if(a&1&&(X(),o(0,"svg",11),M(1,"circle",12),s()),a&2){let e=p();y("viewBox",e._viewBox()),m(),D("stroke-dasharray",e._strokeCircumference(),"px")("stroke-dashoffset",e._strokeCircumference()/2,"px")("stroke-width",e._circleStrokeWidth(),"%"),y("r",e._circleRadius())}}var nt=new ne("mat-progress-spinner-default-options",{providedIn:"root",factory:ot});function ot(){return{diameter:Ze}}var Ze=100,at=10,Xe=(()=>{class a{_elementRef=S(ae);_noopAnimations;get color(){return this._color||this._defaultColor}set color(e){this._color=e}_color;_defaultColor="primary";_determinateCircle;constructor(){let e=S(nt);this._noopAnimations=Te()&&!!e&&!e._forceAnimations,this.mode=this._elementRef.nativeElement.nodeName.toLowerCase()==="mat-spinner"?"indeterminate":"determinate",e&&(e.color&&(this.color=this._defaultColor=e.color),e.diameter&&(this.diameter=e.diameter),e.strokeWidth&&(this.strokeWidth=e.strokeWidth))}mode;get value(){return this.mode==="determinate"?this._value:0}set value(e){this._value=Math.max(0,Math.min(100,e||0))}_value=0;get diameter(){return this._diameter}set diameter(e){this._diameter=e||0}_diameter=Ze;get strokeWidth(){return this._strokeWidth??this.diameter/10}set strokeWidth(e){this._strokeWidth=e||0}_strokeWidth;_circleRadius(){return(this.diameter-at)/2}_viewBox(){let e=this._circleRadius()*2+this.strokeWidth;return`0 0 ${e} ${e}`}_strokeCircumference(){return 2*Math.PI*this._circleRadius()}_strokeDashOffset(){return this.mode==="determinate"?this._strokeCircumference()*(100-this._value)/100:null}_circleStrokeWidth(){return this.strokeWidth/this.diameter*100}static \u0275fac=function(r){return new(r||a)};static \u0275cmp=I({type:a,selectors:[["mat-progress-spinner"],["mat-spinner"]],viewQuery:function(r,t){if(r&1&&le(it,5),r&2){let i;pe(i=de())&&(t._determinateCircle=i.first)}},hostAttrs:["role","progressbar","tabindex","-1",1,"mat-mdc-progress-spinner","mdc-circular-progress"],hostVars:18,hostBindings:function(r,t){r&2&&(y("aria-valuemin",0)("aria-valuemax",100)("aria-valuenow",t.mode==="determinate"?t.value:null)("mode",t.mode),he("mat-"+t.color),D("width",t.diameter,"px")("height",t.diameter,"px")("--mat-progress-spinner-size",t.diameter+"px")("--mat-progress-spinner-active-indicator-width",t.diameter+"px"),ge("_mat-animation-noopable",t._noopAnimations)("mdc-circular-progress--indeterminate",t.mode==="indeterminate"))},inputs:{color:"color",mode:"mode",value:[2,"value","value",A],diameter:[2,"diameter","diameter",A],strokeWidth:[2,"strokeWidth","strokeWidth",A]},exportAs:["matProgressSpinner"],decls:14,vars:11,consts:[["circle",""],["determinateSpinner",""],["aria-hidden","true",1,"mdc-circular-progress__determinate-container"],["xmlns","http://www.w3.org/2000/svg","focusable","false",1,"mdc-circular-progress__determinate-circle-graphic"],["cx","50%","cy","50%",1,"mdc-circular-progress__determinate-circle"],["aria-hidden","true",1,"mdc-circular-progress__indeterminate-container"],[1,"mdc-circular-progress__spinner-layer"],[1,"mdc-circular-progress__circle-clipper","mdc-circular-progress__circle-left"],[3,"ngTemplateOutlet"],[1,"mdc-circular-progress__gap-patch"],[1,"mdc-circular-progress__circle-clipper","mdc-circular-progress__circle-right"],["xmlns","http://www.w3.org/2000/svg","focusable","false",1,"mdc-circular-progress__indeterminate-circle-graphic"],["cx","50%","cy","50%"]],template:function(r,t){if(r&1&&(ce(0,rt,2,8,"ng-template",null,0,ve),o(2,"div",2,1),X(),o(4,"svg",3),M(5,"circle",4),s()(),oe(),o(6,"div",5)(7,"div",6)(8,"div",7),V(9,8),s(),o(10,"div",9),V(11,8),s(),o(12,"div",10),V(13,8),s()()()),r&2){let i=R(1);m(4),y("viewBox",t._viewBox()),m(),D("stroke-dasharray",t._strokeCircumference(),"px")("stroke-dashoffset",t._strokeDashOffset(),"px")("stroke-width",t._circleStrokeWidth(),"%"),y("r",t._circleRadius()),m(4),h("ngTemplateOutlet",i),m(2),h("ngTemplateOutlet",i),m(2),h("ngTemplateOutlet",i)}},dependencies:[we],styles:[`.mat-mdc-progress-spinner{display:block;overflow:hidden;line-height:0;position:relative;direction:ltr;transition:opacity 250ms cubic-bezier(0.4, 0, 0.6, 1)}.mat-mdc-progress-spinner circle{stroke-width:var(--mat-progress-spinner-active-indicator-width, 4px)}.mat-mdc-progress-spinner._mat-animation-noopable,.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__determinate-circle{transition:none !important}.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__indeterminate-circle-graphic,.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__spinner-layer,.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__indeterminate-container{animation:none !important}.mat-mdc-progress-spinner._mat-animation-noopable .mdc-circular-progress__indeterminate-container circle{stroke-dasharray:0 !important}@media(forced-colors: active){.mat-mdc-progress-spinner .mdc-circular-progress__indeterminate-circle-graphic,.mat-mdc-progress-spinner .mdc-circular-progress__determinate-circle{stroke:currentColor;stroke:CanvasText}}.mdc-circular-progress__determinate-container,.mdc-circular-progress__indeterminate-circle-graphic,.mdc-circular-progress__indeterminate-container,.mdc-circular-progress__spinner-layer{position:absolute;width:100%;height:100%}.mdc-circular-progress__determinate-container{transform:rotate(-90deg)}.mdc-circular-progress--indeterminate .mdc-circular-progress__determinate-container{opacity:0}.mdc-circular-progress__indeterminate-container{font-size:0;letter-spacing:0;white-space:nowrap;opacity:0}.mdc-circular-progress--indeterminate .mdc-circular-progress__indeterminate-container{opacity:1;animation:mdc-circular-progress-container-rotate 1568.2352941176ms linear infinite}.mdc-circular-progress__determinate-circle-graphic,.mdc-circular-progress__indeterminate-circle-graphic{fill:rgba(0,0,0,0)}.mat-mdc-progress-spinner .mdc-circular-progress__determinate-circle,.mat-mdc-progress-spinner .mdc-circular-progress__indeterminate-circle-graphic{stroke:var(--mat-progress-spinner-active-indicator-color, var(--mat-sys-primary))}@media(forced-colors: active){.mat-mdc-progress-spinner .mdc-circular-progress__determinate-circle,.mat-mdc-progress-spinner .mdc-circular-progress__indeterminate-circle-graphic{stroke:CanvasText}}.mdc-circular-progress__determinate-circle{transition:stroke-dashoffset 500ms cubic-bezier(0, 0, 0.2, 1)}.mdc-circular-progress__gap-patch{position:absolute;top:0;left:47.5%;box-sizing:border-box;width:5%;height:100%;overflow:hidden}.mdc-circular-progress__gap-patch .mdc-circular-progress__indeterminate-circle-graphic{left:-900%;width:2000%;transform:rotate(180deg)}.mdc-circular-progress__circle-clipper .mdc-circular-progress__indeterminate-circle-graphic{width:200%}.mdc-circular-progress__circle-right .mdc-circular-progress__indeterminate-circle-graphic{left:-100%}.mdc-circular-progress--indeterminate .mdc-circular-progress__circle-left .mdc-circular-progress__indeterminate-circle-graphic{animation:mdc-circular-progress-left-spin 1333ms cubic-bezier(0.4, 0, 0.2, 1) infinite both}.mdc-circular-progress--indeterminate .mdc-circular-progress__circle-right .mdc-circular-progress__indeterminate-circle-graphic{animation:mdc-circular-progress-right-spin 1333ms cubic-bezier(0.4, 0, 0.2, 1) infinite both}.mdc-circular-progress__circle-clipper{display:inline-flex;position:relative;width:50%;height:100%;overflow:hidden}.mdc-circular-progress--indeterminate .mdc-circular-progress__spinner-layer{animation:mdc-circular-progress-spinner-layer-rotate 5332ms cubic-bezier(0.4, 0, 0.2, 1) infinite both}@keyframes mdc-circular-progress-container-rotate{to{transform:rotate(360deg)}}@keyframes mdc-circular-progress-spinner-layer-rotate{12.5%{transform:rotate(135deg)}25%{transform:rotate(270deg)}37.5%{transform:rotate(405deg)}50%{transform:rotate(540deg)}62.5%{transform:rotate(675deg)}75%{transform:rotate(810deg)}87.5%{transform:rotate(945deg)}100%{transform:rotate(1080deg)}}@keyframes mdc-circular-progress-left-spin{from{transform:rotate(265deg)}50%{transform:rotate(130deg)}to{transform:rotate(265deg)}}@keyframes mdc-circular-progress-right-spin{from{transform:rotate(-265deg)}50%{transform:rotate(-130deg)}to{transform:rotate(-265deg)}}
`],encapsulation:2,changeDetection:0})}return a})();var et=(()=>{class a{static \u0275fac=function(r){return new(r||a)};static \u0275mod=se({type:a});static \u0275inj=re({imports:[ke]})}return a})();var ut=["itemList"];function _t(a,g){if(a&1){let e=w();o(0,"mat-list-option",13),_("selectedChange",function(t){let i=d(e).$implicit,n=p();return u(n.toggleSelection(i,t))}),c(1),s()}if(a&2){let e=g.$implicit,r=p();h("value",e)("selected",r.isSelected(e))("matTooltip",e),m(),k(" ",e," ")}}var tt=(()=>{class a{dialogRef=S(ye);dataSignal=x(S(Me));searchTerm=x("");selectedItems=x([...this.dataSignal().selected]);filtered=F(()=>{let e=this.searchTerm().toLowerCase();return this.dataSignal().items.filter(r=>r.toLowerCase().includes(e))});canAdd=F(()=>{let e=this.searchTerm().trim();return e!==""&&!this.dataSignal().items.includes(e)});itemList=xe.required("itemList");addItem(){let e=this.searchTerm().trim();if(!e||this.dataSignal().items.includes(e))return;let r=v(C({},this.dataSignal()),{items:[...this.dataSignal().items,e]});this.dataSignal.set(r),this.searchTerm.set("")}apply(){this.dialogRef.close(this.selectedItems())}toggleSelection(e,r){let t=this.selectedItems();r&&!t.includes(e)?this.selectedItems.set([...t,e]):!r&&t.includes(e)&&this.selectedItems.set(t.filter(i=>i!==e))}isSelected(e){return this.selectedItems().includes(e)}static \u0275fac=function(r){return new(r||a)};static \u0275cmp=I({type:a,selectors:[["lib-list-item-selector-dialog"]],viewQuery:function(r,t){r&1&&ue(t.itemList,ut,5),r&2&&_e()},decls:22,vars:4,consts:[["itemList","matSelectionList"],["mat-dialog-title",""],[2,"height","calc(100vh - 60px)","display","flex","flex-direction","column"],[1,"search-add-container",2,"display","flex","align-items","center","gap","8px"],["appearance","fill",1,"search-field",2,"flex","1"],["matInput","","placeholder","Type to filter...","aria-label","Search Items",3,"input","value"],["mat-icon-button","","color","primary","aria-label","Add new item",3,"click","disabled"],[1,"selection-count",2,"font-size","12px","text-align","right","margin-bottom","8px"],[2,"flex","1","overflow","auto"],["matTooltipShowDelay","500",3,"value","selected","matTooltip"],["align","end"],["mat-button","",3,"click"],["mat-button","","color","primary",3,"click"],["matTooltipShowDelay","500",3,"selectedChange","value","selected","matTooltip"]],template:function(r,t){if(r&1){let i=w();o(0,"h2",1),c(1,"Select Items"),s(),o(2,"mat-dialog-content",2)(3,"div",3)(4,"mat-form-field",4)(5,"mat-label"),c(6,"Search items"),s(),o(7,"input",5),_("input",function(l){return d(i),u(t.searchTerm.set(l.target.value))}),s()(),o(8,"button",6),_("click",function(){return d(i),u(t.addItem())}),o(9,"mat-icon"),c(10,"add"),s()()(),o(11,"div",7),c(12),s(),o(13,"mat-selection-list",8,0),b(15,_t,2,4,"mat-list-option",9,L),s()(),o(17,"mat-dialog-actions",10)(18,"button",11),_("click",function(){return d(i),u(t.dialogRef.close())}),c(19,"Cancel"),s(),o(20,"button",12),_("click",function(){return d(i),u(t.apply())}),c(21,"Add"),s()()}r&2&&(m(7),h("value",t.searchTerm()),m(),h("disabled",!t.canAdd()),m(4),Ce(" ",t.selectedItems().length," / ",t.dataSignal().items.length," items "),m(3),T(t.filtered()))},dependencies:[Ke,Je,G,Ee,Le,Fe,z,N,j,Q,U,Y,K,J,W,O,$,H,q],encapsulation:2,changeDetection:0})}return a})();var Z=(a,g)=>g.value;function gt(a,g){if(a&1){let e=w();o(0,"mat-list-option",10),_("click",function(t){let i=d(e),n=i.$implicit,l=i.$index,f=p(2);return t.preventDefault(),u(f.toggleCommonTarget(l,n.value,!n.selected))}),o(1,"button",11),_("click",function(t){let i=d(e).$implicit,n=p(2);return t.stopPropagation(),u(n.removeCommonTarget(i.value))}),o(2,"mat-icon"),c(3,"close"),s()(),c(4),s()}if(a&2){let e=g.$implicit;h("value",e.value)("selected",e.selected),m(4),k(" ",e.value," ")}}function ht(a,g){if(a&1&&(o(0,"div")(1,"mat-label"),c(2,"Common Targets"),s(),o(3,"mat-selection-list",null,1),b(5,gt,5,3,"mat-list-option",9,Z),s()()),a&2){let e=p();m(5),T(e.commonTargets())}}function ft(a,g){if(a&1){let e=w();o(0,"mat-list-option",10),_("click",function(t){let i=d(e),n=i.$implicit,l=i.$index,f=p(2);return t.preventDefault(),u(f.toggleCommonPrompt(l,n.value,!n.selected))}),o(1,"button",11),_("click",function(t){let i=d(e).$implicit,n=p(2);return t.stopPropagation(),u(n.removeCommonPrompt(i.value))}),o(2,"mat-icon"),c(3,"close"),s()(),c(4),s()}if(a&2){let e=g.$implicit;h("value",e.value)("selected",e.selected),m(4),k(" ",e.value," ")}}function Ct(a,g){if(a&1&&(o(0,"div")(1,"mat-label"),c(2,"Common Prompts"),s(),o(3,"mat-selection-list",null,2),b(5,ft,5,3,"mat-list-option",9,Z),s()()),a&2){let e=p();m(5),T(e.commonPrompts())}}function vt(a,g){if(a&1){let e=w();o(0,"mat-list-option",10),_("click",function(t){let i=d(e).$implicit,n=p().$index,l=p(2);return t.preventDefault(),u(l.toggleTarget(n,i.value,!i.selected))}),o(1,"button",11),_("click",function(t){let i=d(e).$implicit,n=p().$index,l=p(2);return t.stopPropagation(),u(l.removeTarget(n,i.value))}),o(2,"mat-icon"),c(3,"close"),s()(),c(4),s()}if(a&2){let e=g.$implicit;h("value",e.value)("selected",e.selected),m(4),k(" ",e.value," ")}}function xt(a,g){if(a&1){let e=w();o(0,"mat-list-option",10),_("click",function(t){let i=d(e).$implicit,n=p().$index,l=p(2);return t.preventDefault(),u(l.togglePrompt(n,i.value,!i.selected))}),o(1,"button",18),_("click",function(t){let i=d(e).$implicit,n=p().$index,l=p(2);return t.stopPropagation(),u(l.runItemPrompt(n,i.value))}),o(2,"mat-icon"),c(3,"play_arrow"),s()(),o(4,"button",11),_("click",function(t){let i=d(e).$implicit,n=p().$index,l=p(2);return t.stopPropagation(),u(l.removePrompt(n,i.value))}),o(5,"mat-icon"),c(6,"close"),s()(),c(7),s()}if(a&2){let e=g.$implicit,r=p(3);h("value",e.value)("selected",e.selected),m(),h("disabled",r.isProcessing()),m(6),k(" ",e.value," ")}}function wt(a,g){if(a&1){let e=w();o(0,"mat-expansion-panel")(1,"mat-expansion-panel-header")(2,"mat-panel-title"),c(3),s(),o(4,"div",16),_("click",function(t){return d(e),u(t.stopPropagation())}),o(5,"button",17),_("click",function(){let t=d(e).$index,i=p(2);return u(i.addTargets(t))}),o(6,"mat-icon"),c(7,"add"),s()(),o(8,"button",17),_("click",function(){let t=d(e).$index,i=p(2);return u(i.addPromptsToBatch(t))}),o(9,"mat-icon"),c(10,"format_list_bulleted"),s()(),o(11,"button",11),_("click",function(){let t=d(e).$index,i=p(2);return u(i.removeBatchItem(t))}),o(12,"mat-icon"),c(13,"delete"),s()()()(),o(14,"div")(15,"h3"),c(16,"Targets"),s(),o(17,"mat-selection-list"),b(18,vt,5,3,"mat-list-option",9,Z),s()(),o(20,"div")(21,"h3"),c(22,"Prompts"),s(),o(23,"mat-selection-list"),b(24,xt,8,4,"mat-list-option",9,Z),s()()()}if(a&2){let e=g.$implicit,r=g.$index;m(3),k("Batch ",r+1),m(15),T(e.targets),m(6),T(e.prompts)}}function St(a,g){a&1&&M(0,"mat-progress-spinner",15)}function bt(a,g){if(a&1&&(o(0,"mat-list-item"),c(1),s()),a&2){let e=g.$implicit;m(),fe(e)}}function Tt(a,g){if(a&1){let e=w();o(0,"mat-accordion"),b(1,wt,26,1,"mat-expansion-panel",null,me),s(),o(3,"div")(4,"mat-form-field",12)(5,"mat-label"),c(6,"Delay (minutes)"),s(),o(7,"input",13),_("input",function(t){d(e);let i=p();return u(i.delayInMinutes.set(+t.target.value))}),s()(),o(8,"button",14),_("click",function(){d(e);let t=p();return u(t.runAllPrompts())}),c(9," Master Submit All "),s()(),B(10,St,1,0,"mat-progress-spinner",15),o(11,"mat-list"),b(12,bt,2,1,"mat-list-item",null,L),s()}if(a&2){let e=p();m(),T(e.batchItems()),m(6),h("value",e.delayInMinutes()),m(),h("disabled",!e.hasBatchItems()),m(2),E(e.isProcessing()?10:-1),m(2),T(e.sessionLogs())}}var kt=(()=>{class a{exportConfig(e){let r=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),t=URL.createObjectURL(r),i=document.createElement("a");i.href=t,i.download="batch-config.json",i.click(),URL.revokeObjectURL(t)}importConfig(e){return new Promise((r,t)=>{let i=new FileReader;i.onload=()=>{try{let n=JSON.parse(i.result);r(n)}catch(n){t(n)}},i.onerror=n=>t(n),i.readAsText(e)})}static \u0275fac=function(r){return new(r||a)};static \u0275prov=ie({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),wi=(()=>{class a{dialog=S(Be);configService=S(kt);snackBar=S(We);batchItems=x([]);commonPrompts=x([]);commonTargets=x([]);isProcessing=x(!1);sessionLogs=x([]);delayInMinutes=x(5);isClientActive=x(!1);hasBatchItems=F(()=>this.batchItems().length>0);initialDelayMs=1e3;pingTimeoutMs=5e3;offlineFileList=[];ngOnInit(){this.pingClient()}async addBatchItem(){let e=await this.getWorkspaceFiles();this.openFileSelector(e,[],r=>{this.batchItems.update(t=>[...t,...r.map(i=>({targets:[{value:i,selected:!0}],prompts:[]}))])})}removeBatchItem(e){this.updateBatchItemsExcluding(e)}async addTargets(e){let r=this.batchItems()[e],t=await this.getWorkspaceFiles(),i=r.targets.map(n=>n.value);this.openFileSelector(t,i,n=>{this.updateBatchItemAtIndex(e,v(C({},this.batchItems()[e]),{targets:n.map(l=>({value:l,selected:!0}))}))})}removeTarget(e,r){let t=this.batchItems()[e];this.updateBatchItemAtIndex(e,v(C({},t),{targets:t.targets.filter(i=>i.value!==r)}))}toggleTarget(e,r,t){let i=this.batchItems()[e];this.updateBatchItemAtIndex(e,v(C({},i),{targets:i.targets.map(n=>n.value===r?v(C({},n),{selected:t}):n)}))}addPromptsToBatch(e){let r=this.batchItems()[e],t=r.prompts.map(n=>n.value),i=r.prompts.filter(n=>n.selected).map(n=>n.value);this.openItemSelector(t,i,n=>{let l=n.map(f=>r.prompts.find(P=>P.value===f)||{value:f,selected:!0});this.updateBatchItemAtIndex(e,v(C({},r),{prompts:l}))})}removePrompt(e,r){let t=this.batchItems()[e];this.updateBatchItemAtIndex(e,v(C({},t),{prompts:t.prompts.filter(i=>i.value!==r)}))}togglePrompt(e,r,t){let i=this.batchItems()[e];this.updateBatchItemAtIndex(e,v(C({},i),{prompts:i.prompts.map(n=>n.value===r?v(C({},n),{selected:t}):n)}))}selectCommonPrompts(){let e=this.commonPrompts().map(t=>t.value),r=this.commonPrompts().filter(t=>t.selected).map(t=>t.value);this.openItemSelector(e,r,t=>{let i=t.map(n=>this.commonPrompts().find(f=>f.value===n)||{value:n,selected:!0});this.commonPrompts.set(this.createDeepCopy(i))})}removeCommonPrompt(e){this.commonPrompts.set(this.commonPrompts().filter(r=>r.value!==e))}toggleCommonPrompt(e,r,t){this.commonPrompts.set(this.commonPrompts().map((i,n)=>n===e?v(C({},i),{selected:t}):i))}async selectCommonTargets(){let e=await this.getWorkspaceFiles(),r=this.commonTargets().filter(t=>t.selected).map(t=>t.value);this.openFileSelector(e,r,t=>{let i=t.map(n=>this.commonTargets().find(f=>f.value===n)||{value:n,selected:!0});this.commonTargets.set(i)})}removeCommonTarget(e){this.commonTargets.set(this.commonTargets().filter(r=>r.value!==e))}toggleCommonTarget(e,r,t){this.commonTargets.set(this.commonTargets().map((i,n)=>n===e?v(C({},i),{selected:t}):i))}async runItemPrompt(e,r){let i=this.batchItems()[e].targets.filter(n=>n.selected).map(n=>n.value);this.isProcessing.set(!0),await this.executePromptSession(i,r),this.isProcessing.set(!1)}async runAllPrompts(){this.isProcessing.set(!0);for(let e of this.batchItems()){let r=[...e.prompts.filter(i=>i.selected).map(i=>i.value),...this.commonPrompts().filter(i=>i.selected).map(i=>i.value)],t=[...e.targets.filter(i=>i.selected).map(i=>i.value),...this.commonTargets().filter(i=>i.selected).map(i=>i.value)];for(let i of r)await this.executePromptSession(t,i),await this.delay(this.delayInMinutes()*60*1e3)}this.isProcessing.set(!1),this.sessionLogs.update(e=>[...e,"Master submission completed"])}saveConfig(){let e={batchItems:this.batchItems(),commonPrompts:this.commonPrompts(),commonTargets:this.commonTargets(),offlineFileList:this.offlineFileList};this.configService.exportConfig(e)}uploadConfig(e){let r=e.target,t=r.files?.[0];t&&(this.configService.importConfig(t).then(i=>{this.batchItems.set(i.batchItems),this.commonPrompts.set(i.commonPrompts),this.commonTargets.set(i.commonTargets),i.offlineFileList?.length&&(this.offlineFileList=i.offlineFileList)}),r.value="")}async getWorkspaceFiles(){return this.isClientActive()?new Promise(e=>{let r=i=>{if(i.data?.command==="workspaceFiles"){window.removeEventListener("message",r);let n=i.data.files??[];clearTimeout(t),n.length>0?(this.offlineFileList=n,e(n)):this.offlineFileList.length>0?(this.snackBar.open("Loading files from cached list","Close",{duration:3e3}),e(this.offlineFileList)):e([])}};window.addEventListener("message",r),window.parent.postMessage({command:"getWorkspaceFiles"},"*");let t=setTimeout(()=>{window.removeEventListener("message",r),this.offlineFileList.length>0?(this.snackBar.open("Timed out loading workspace files, using cached list","Close",{duration:4e3}),e(this.offlineFileList)):e([])},15e3)}):this.offlineFileList.length>0?(this.snackBar.open("Using cached file list (client not active)","Close",{duration:4e3}),this.offlineFileList):(this.snackBar.open("Client not active and no cached files available","Close",{duration:4e3}),[])}openFileSelector(e,r,t){this.openItemSelector(e,r,t)}openItemSelector(e,r,t){this.dialog.open(tt,{data:{items:e.sort(),selected:r},height:"calc(100% - 30px)",width:"calc(100% - 30px)",maxWidth:"100%",maxHeight:"100%"}).afterClosed().subscribe(n=>{n&&t(n)})}updateBatchItemsExcluding(e){let r=this.createDeepCopy(this.batchItems());this.batchItems.set(r.filter((t,i)=>i!==e))}updateBatchItemAtIndex(e,r){let i=this.createDeepCopy(this.batchItems()).map((n,l)=>l===e?r:n);this.batchItems.set(i)}async executePromptSession(e,r){let t=this.sendCommandAsync("getContextKeyValue","chatEdits.isRequestInProgress");await this.sendCommandAsync("workbench.action.chat.newEditSession");for(let i of e)await this.sendCommandAsync("workbench.action.chat.attachFile",i);await this.sendCommandAsync("workbench.action.chat.open",{mode:"agent",query:r})}sendCommand(e,r){window.parent.postMessage({command:"executeCommand",commandName:e,args:r},"*")}async sendCommandAsync(e,r,t=5e3){return new Promise((i,n)=>{let l=Date.now().toString()+Math.random().toString(36),f=P=>{P.data?.command==="commandResponse"&&P.data?.requestId===l&&(window.removeEventListener("message",f),clearTimeout(ee),P.data.success?i(P.data.result):n(new Error(P.data.error||`Command '${e}' failed`)))};window.addEventListener("message",f),window.parent.postMessage({command:"executeCommand",commandName:e,args:r,requestId:l},"*");let ee=setTimeout(()=>{window.removeEventListener("message",f),n(new Error(`Command '${e}' timed out after ${t}ms`))},t)})}delay(e){return new Promise(r=>setTimeout(r,e))}pingClient(){return new Promise(e=>{let r=i=>{i.data?.command==="ping"&&i.data?.message==="pong"&&(window.removeEventListener("message",r),clearTimeout(t),this.isClientActive.set(!0),this.sessionLogs.update(n=>[...n,"Client connection active"]),e(!0))};window.addEventListener("message",r),window.parent.postMessage({command:"ping"},"*");let t=setTimeout(()=>{window.removeEventListener("message",r),this.isClientActive.set(!1),this.sessionLogs.update(i=>[...i,"Client connection not detected"]),this.snackBar.open("Client connection not detected, using offline mode","Close",{duration:4e3}),e(!1)},this.pingTimeoutMs)})}createDeepCopy(e){return JSON.parse(JSON.stringify(e))}static \u0275fac=function(r){return new(r||a)};static \u0275cmp=I({type:a,selectors:[["lib-prompt-batch-runner"]],decls:25,vars:3,consts:[["configInput",""],["commonTargetsList",""],["commonPromptsList",""],["mat-mini-fab","","color","primary",3,"click"],["mat-mini-fab","","color","accent","aria-label","Select Common Prompts",3,"click"],["mat-mini-fab","","color","accent","aria-label","Select Common Targets",3,"click"],["type","file","accept","application/json","hidden","",3,"change"],["mat-mini-fab","","color","primary","aria-label","Upload Config",3,"click"],["mat-mini-fab","","color","primary","aria-label","Save Config",3,"click"],[3,"value","selected"],[3,"click","value","selected"],["mat-icon-button","","color","warn",3,"click"],["appearance","fill"],["matInput","","type","number","min","1","required","",3,"input","value"],["mat-raised-button","","color","primary",3,"click","disabled"],["diameter","50","mode","indeterminate"],[3,"click"],["mat-icon-button","",3,"click"],["mat-icon-button","","color","primary",3,"click","disabled"]],template:function(r,t){if(r&1){let i=w();o(0,"mat-toolbar")(1,"span"),c(2,"Prompt Batch Runner"),s()(),M(3,"span"),o(4,"div")(5,"button",3),_("click",function(){return d(i),u(t.addBatchItem())}),o(6,"mat-icon"),c(7,"add"),s()(),o(8,"button",4),_("click",function(){return d(i),u(t.selectCommonPrompts())}),o(9,"mat-icon"),c(10,"format_list_bulleted"),s()(),o(11,"button",5),_("click",function(){return d(i),u(t.selectCommonTargets())}),o(12,"mat-icon"),c(13,"folder"),s()(),o(14,"input",6,0),_("change",function(l){return d(i),u(t.uploadConfig(l))}),s(),o(16,"button",7),_("click",function(){d(i);let l=R(15);return u(l.click())}),o(17,"mat-icon"),c(18,"upload"),s()(),o(19,"button",8),_("click",function(){return d(i),u(t.saveConfig())}),o(20,"mat-icon"),c(21,"save"),s()()(),B(22,ht,7,0,"div"),B(23,Ct,7,0,"div"),B(24,Tt,14,3)}r&2&&(m(22),E(t.commonTargets().length?22:-1),m(),E(t.commonPrompts().length?23:-1),m(),E(t.hasBatchItems()?24:-1))},dependencies:[be,Ie,W,O,Pe,$,H,q,z,N,j,Q,U,Y,Re,K,De,J,Ve,Ae,et,Xe,Qe,Ue,ze,qe,He,Oe,$e,je,Ne,G,Ge],encapsulation:2,changeDetection:0})}return te([Se({message:"Loading workspace files..."})],a.prototype,"getWorkspaceFiles",null),a})();export{wi as PromptBatchRunnerComponent};
